{% load i18n %}
{% load svg_tags %}
<div id="question-list" class="space-y-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold">
      {% if questions %}
        {% translate "Questions" %} ({{ questions|length }})
      {% else %}
        {% translate "No questions yet" %}
      {% endif %}
    </h2>
    <!-- Filter dropdown and refresh -->
    <div class="relative">
      <div class="flex items-center gap-2">
        <label for="filter" class="text-sm text-muted">{% translate "Filter:" %}</label>
        <select id="filter"
                name="status_filter"
                class="form-select text-sm min-w-[10rem]"
                hx-get="{% url 'talk_questions' talk.id %}"
                hx-trigger="change"
                hx-target="#question-list"
                hx-swap="outerHTML"
                hx-push-url="true">
          <option value="all" {% if status_filter == 'all' %}selected{% endif %}>{% translate "All" %}</option>
          <option value="mine" {% if status_filter == 'mine' %}selected{% endif %}>{% translate "My questions" %}</option>
          <option value="approved"
                  {% if status_filter == 'approved' %}selected{% endif %}>{% translate "Active" %}</option>
          <option value="answered"
                  {% if status_filter == 'answered' %}selected{% endif %}>{% translate "Answered" %}</option>
          {% if user_can_moderate %}
            <option value="rejected"
                    {% if status_filter == 'rejected' %}selected{% endif %}>{% translate "Rejected" %}</option>
          {% endif %}
        </select>
        <button class="btn-outline-primary inline-flex items-center gap-1.5 text-sm px-2.5 py-1.5"
                hx-get="{% url 'talk_questions' talk.id %}"
                hx-include="#filter"
                hx-push-url="true"
                hx-target="#question-list"
                hx-swap="outerHTML"
                title="{% translate "Refresh" %}">
          {% svg 'arrow-path' "h-4 w-4" %}
          <span>{% translate "Refresh" %}</span>
        </button>
      </div>
    </div>
  </div>
  {% if user_can_moderate %}
    <div class="alert-warning mb-4">
      <p class="font-medium">{% translate "Moderator View" %}</p>
      <p class="text-sm">
        {% translate "You are viewing this page as a moderator. All questions are visible by default. You can reject questions that violate guidelines or are inappropriate." %}
      </p>
    </div>
  {% endif %}
  {% for question in questions %}
    <div id="question-{{ question.id }}"
         class="card hover:shadow-lg transition-shadow">
      <div class="flex items-start">
        <!-- Voting button -->
        {% include "talks/questions/vote_button.html" with question=question %}
        <!-- Question content -->
        <div class="flex-1">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-muted">{{ question.display_name }}</span>
            <!-- Status badges -->
            {% if question.status == 'answered' %}
              <span class="badge badge-blue text-xs px-2 py-1">{% translate "Answered" %}</span>
            {% elif question.status == 'rejected' %}
              <span class="badge badge-red text-xs px-2 py-1">{% translate "Rejected" %}</span>
            {% endif %}
          </div>
          <p class="text-strong mb-4">{{ question.content|linebreaksbr }}</p>
          <!-- Timestamp -->
          <div class="text-xs text-subtle mb-2">
            {% translate "Asked" %} {{ question.created_at|timesince }} {% translate "ago" %}
          </div>
          <!-- Moderator actions -->
          {% if user_can_moderate or question.user_id == request.user.id %}
            <div class="flex flex-wrap gap-2 mt-2">
              {% if user_can_moderate %}
                {# Questions can be either rejected or marked as answered #}
                {% if question.status == 'approved' %}
                  <button class="text-sm inline-flex items-center gap-1 badge badge-red hover:bg-red-200 px-2 py-1"
                          hx-post="{% url 'question_reject' question.id %}"
                          hx-vals='{"status_filter":"{{ status_filter }}"}'
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% svg 'x-mark' "h-4 w-4" %} {% translate "Reject Question" %}</button>
                  <button class="text-sm inline-flex items-center gap-1 badge badge-blue hover:bg-blue-200 px-2 py-1"
                          hx-post="{% url 'question_mark_answered' question.id %}"
                          hx-vals='{"status_filter":"{{ status_filter }}"}'
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">
                    {% svg 'chat-bubble-left-ellipsis' "h-4 w-4" %} {% translate "Mark Answered" %}
                  </button>
                {% endif %}
                {# Answered: can be rejected #}
                {% if question.status == 'answered' %}
                  <button class="text-sm inline-flex items-center gap-1 badge badge-red hover:bg-red-200 px-2 py-1"
                          hx-post="{% url 'question_reject' question.id %}"
                          hx-vals='{"status_filter":"{{ status_filter }}"}'
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% svg 'x-mark' "h-4 w-4" %} {% translate "Reject Question" %}</button>
                {% endif %}
                {# Rejected: can move to approved (eg.: misclick) #}
                {% if question.status == 'rejected' %}
                  <button class="text-sm inline-flex items-center gap-1 badge badge-green hover:bg-green-200 px-2 py-1"
                          hx-post="{% url 'question_approve' question.id %}"
                          hx-vals='{"status_filter":"{{ status_filter }}"}'
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% svg 'check-circle' "h-4 w-4" %} {% translate "Approve" %}</button>
                {% endif %}
              {% endif %}
              {% if question.user_id == request.user.id %}
                <button class="text-sm inline-flex items-center gap-1 badge badge-blue hover:bg-blue-200 px-2 py-1"
                        hx-get="{% url 'question_edit' question.id %}"
                        hx-vals='{"status_filter":"{{ status_filter }}"}'
                        hx-target="#question-{{ question.id }}"
                        hx-swap="outerHTML"
                        title="{% translate "Edit" %}">
                  {% svg 'pencil-square' "h-4 w-4" %} {% translate "Edit" %}
                </button>
                <button class="text-sm inline-flex items-center gap-1 badge px-2 py-1 badge-red hover:bg-red-200"
                        hx-post="{% url 'question_delete' question.id %}"
                        hx-vals='{"status_filter":"{{ status_filter }}"}'
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                        hx-target="#question-list"
                        hx-swap="outerHTML"
                        title="{% translate "Delete" %}">{% svg 'trash' "h-4 w-4" %} {% translate "Delete" %}</button>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% empty %}
    <div class="box-muted text-center">
      {% if status_filter == "mine" %}
        <p class="text-muted">{% translate "You haven't asked any questions yet." %}</p>
      {% elif status_filter == "pending" %}
        <p class="text-muted">{% translate "There are no pending questions right now." %}</p>
      {% elif status_filter == "approved" %}
        <p class="text-muted">{% translate "There are no approved questions right now." %}</p>
      {% elif status_filter == "answered" %}
        <p class="text-muted">{% translate "There are no answered questions yet." %}</p>
      {% elif status_filter == "rejected" %}
        <p class="text-muted">{% translate "There are no rejected questions." %}</p>
      {% else %}
        <p class="text-muted">{% translate "No questions match the selected filter." %}</p>
      {% endif %}
      <p class="text-sm text-subtle mt-2">{% translate "Try changing the filter or ask a new question above." %}</p>
    </div>
  {% endfor %}
</div>
