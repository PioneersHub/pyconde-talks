{% load i18n %}
{% load svg_tags %}
<div id="question-list" class="space-y-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold">
      {% if questions %}
        {% translate "Questions" %} ({{ questions|length }})
      {% else %}
        {% translate "No questions yet" %}
      {% endif %}
    </h2>
    <!-- Filter dropdown and refresh -->
    <div class="relative">
      <div class="flex items-center gap-2">
        <label for="filter" class="text-sm text-gray-600">{% translate "Filter:" %}</label>
        <select id="filter"
                name="status_filter"
                class="border rounded px-2 py-1 text-sm pr-8 min-w-[10rem]"
                hx-get="{% url 'talk_questions' talk.id %}"
                hx-trigger="change"
                hx-target="#question-list"
                hx-swap="outerHTML"
                hx-push-url="true">
          <option value="all" {% if status_filter == 'all' %}selected{% endif %}>{% translate "All" %}</option>
          <option value="mine" {% if status_filter == 'mine' %}selected{% endif %}>{% translate "My questions" %}</option>
          {% if user_can_moderate %}
            <option value="pending"
                    {% if status_filter == 'pending' %}selected{% endif %}>{% translate "Pending" %}</option>
            <option value="approved"
                    {% if status_filter == 'approved' %}selected{% endif %}>{% translate "Approved" %}</option>
            <option value="answered"
                    {% if status_filter == 'answered' %}selected{% endif %}>{% translate "Answered" %}</option>
            <option value="rejected"
                    {% if status_filter == 'rejected' %}selected{% endif %}>{% translate "Rejected" %}</option>
          {% else %}
            <option value="approved"
                    {% if status_filter == 'approved' %}selected{% endif %}>{% translate "Approved" %}</option>
            <option value="answered"
                    {% if status_filter == 'answered' %}selected{% endif %}>{% translate "Answered" %}</option>
          {% endif %}
        </select>
        <button class="inline-flex items-center gap-1.5 text-sm px-2.5 py-1.5 bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-300 rounded-md shadow-sm"
                hx-get="{% url 'talk_questions' talk.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                hx-target="#question-list"
                hx-swap="outerHTML"
                title="{% translate "Refresh" %}">
          {% svg 'arrow-path' "h-4 w-4" %}
          <span>{% translate "Refresh" %}</span>
        </button>
      </div>
    </div>
  </div>
  {% if user_can_moderate %}
    <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-md mb-4">
      <p class="font-medium">{% translate "Moderator View" %}</p>
      <p class="text-sm">
        {% translate "You are viewing this page as a moderator and can see all questions including pending and rejected ones." %}
      </p>
    </div>
  {% endif %}
  {% for question in questions %}
    <div id="question-{{ question.id }}"
         class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
      <div class="flex items-start">
        <!-- Voting button -->
        {% include "talks/questions/vote_button.html" with question=question %}
        <!-- Question content -->
        <div class="flex-1">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-gray-600">{{ question.display_name }}</span>
            <!-- Status badges -->
            {% if question.status == 'pending' %}
              <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">{% translate "Pending" %}</span>
            {% elif question.status == 'approved' %}
              <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">{% translate "Approved" %}</span>
            {% elif question.status == 'answered' %}
              <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">{% translate "Answered" %}</span>
            {% elif question.status == 'rejected' %}
              <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">{% translate "Rejected" %}</span>
            {% endif %}
          </div>
          <p class="text-gray-800 mb-4">{{ question.content }}</p>
          <!-- Timestamp -->
          <div class="text-xs text-gray-500 mb-2">
            {% translate "Asked" %} {{ question.created_at|timesince }} {% translate "ago" %}
          </div>
          <!-- Moderator actions -->
          {% if user_can_moderate or question.user_id == request.user.id %}
            <div class="flex flex-wrap gap-2 mt-2">
              {% if user_can_moderate %}
                {# Pending: can approve, reject, answer #}
                {% if question.status == 'pending' %}
                  <button class="text-sm bg-green-100 text-green-700 hover:bg-green-200 px-2 py-1 rounded"
                          hx-post="{% url 'question_approve' question.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% translate "Approve" %}</button>
                  <button class="text-sm bg-red-100 text-red-700 hover:bg-red-200 px-2 py-1 rounded"
                          hx-post="{% url 'question_reject' question.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% translate "Reject" %}</button>
                  <button class="text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded"
                          hx-post="{% url 'question_mark_answered' question.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% translate "Mark Answered" %}</button>
                {% endif %}
                {# Approved: can reject or answer #}
                {% if question.status == 'approved' %}
                  <button class="text-sm bg-red-100 text-red-700 hover:bg-red-200 px-2 py-1 rounded"
                          hx-post="{% url 'question_reject' question.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% translate "Reject" %}</button>
                  <button class="text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded"
                          hx-post="{% url 'question_mark_answered' question.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% translate "Mark Answered" %}</button>
                {% endif %}
                {# Answered: can move to approved or reject #}
                {% if question.status == 'answered' %}
                  <button class="text-sm bg-green-100 text-green-700 hover:bg-green-200 px-2 py-1 rounded"
                          hx-post="{% url 'question_approve' question.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% translate "Mark Approved" %}</button>
                  <button class="text-sm bg-red-100 text-red-700 hover:bg-red-200 px-2 py-1 rounded"
                          hx-post="{% url 'question_reject' question.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% translate "Reject" %}</button>
                {% endif %}
                {# Rejected: can move to approved #}
                {% if question.status == 'rejected' %}
                  <button class="text-sm bg-green-100 text-green-700 hover:bg-green-200 px-2 py-1 rounded"
                          hx-post="{% url 'question_approve' question.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                          hx-target="#question-list"
                          hx-swap="outerHTML">{% translate "Approve" %}</button>
                {% endif %}
              {% endif %}
              {% if question.user_id == request.user.id %}
                <button class="text-sm inline-flex items-center gap-1 bg-gray-100 text-gray-700 hover:bg-gray-200 px-2 py-1 rounded"
                        hx-get="{% url 'question_edit' question.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                        hx-target="#question-{{ question.id }}"
                        hx-swap="outerHTML"
                        title="{% translate "Edit" %}">
                  {% load svg_tags %}
                  {% svg 'pencil-square' "h-4 w-4" %} {% translate "Edit" %}
                </button>
                <button class="text-sm inline-flex items-center gap-1 bg-red-100 text-red-700 hover:bg-red-200 px-2 py-1 rounded"
                        hx-post="{% url 'question_delete' question.id %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}"
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                        hx-target="#question-list"
                        hx-swap="outerHTML"
                        title="{% translate "Delete" %}">
                  {% load svg_tags %}
                  {% svg 'trash' "h-4 w-4" %} {% translate "Delete" %}
                </button>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% empty %}
    <div class="bg-gray-50 p-6 rounded-lg text-center">
      {% if status_filter == "mine" %}
        <p class="text-gray-600">{% translate "You haven't asked any questions yet." %}</p>
      {% elif status_filter == "pending" %}
        <p class="text-gray-600">{% translate "There are no pending questions right now." %}</p>
      {% elif status_filter == "approved" %}
        <p class="text-gray-600">{% translate "There are no approved questions right now." %}</p>
      {% elif status_filter == "answered" %}
        <p class="text-gray-600">{% translate "There are no answered questions yet." %}</p>
      {% elif status_filter == "rejected" %}
        <p class="text-gray-600">{% translate "There are no rejected questions." %}</p>
      {% else %}
        <p class="text-gray-600">{% translate "No questions match the selected filter." %}</p>
      {% endif %}
      <p class="text-sm text-gray-500 mt-2">{% translate "Try changing the filter or ask a new question above." %}</p>
    </div>
  {% endfor %}
</div>
