{% extends "base.html" %}
{% load partials %}
{% load svg_tags %}
{% load highlight %}
{% load rating_tags %}
{% block content %}
  <div class="max-w-4xl mx-auto p-4">
    <!-- Search -->
    <div class="card-compact mb-4">
      <form id="search-form"
            hx-get="{% url 'talk_list' %}"
            hx-target="#talks-container"
            hx-push-url="true"
            hx-trigger="keyup changed delay:300ms from:input[name='q'], change from:select"
            hx-include="#filters-form, #search-form"
            hx-indicator="#loading-indicator"
            class="flex flex-wrap gap-3 items-center">
        <input type="search"
               name="q"
               value="{{ search_query }}"
               placeholder="Search talks"
               class="form-input w-72"
               aria-label="Search talks" />
        <fieldset class="flex flex-wrap gap-3 items-center">
          <legend class="sr-only">Search scope</legend>
          <label class="inline-flex items-center gap-1">
            <input type="checkbox"
                   name="search_in"
                   value="title"
                   {% if 'all' in search_in or 'title' in search_in %}checked{% endif %} />
            <span>Title</span>
          </label>
          <label class="inline-flex items-center gap-1">
            <input type="checkbox"
                   name="search_in"
                   value="description"
                   {% if 'all' in search_in or 'description' in search_in %}checked{% endif %} />
            <span>Description</span>
          </label>
          <label class="inline-flex items-center gap-1">
            <input type="checkbox"
                   name="search_in"
                   value="author"
                   {% if 'all' in search_in or 'author' in search_in %}checked{% endif %} />
            <span>Author</span>
          </label>
        </fieldset>
        <button type="button"
                class="btn-secondary"
                hx-get="{% url 'talk_list' %}"
                hx-target="#talks-container"
                hx-push-url="true"
                hx-indicator="#loading-indicator"
                hx-include="#filters-form"
                hx-vals='{"q":"","search_in":["title","description","author"]}'>Clear</button>
        <!-- spinner -->
        <div id="loading-indicator" class="htmx-indicator">{% svg 'spinner' "animate-spin h-5 w-5 text-brand-blue" %}</div>
      </form>
    </div>
    <!-- Filters -->
    <div class="card-compact mb-6">
      <form id="filters-form"
            hx-get="{% url 'talk_list' %}"
            hx-target="#talks-container"
            hx-push-url="true"
            hx-trigger="change from:select"
            hx-include="#filters-form, #search-form"
            hx-indicator="#loading-indicator"
            class="flex flex-wrap gap-4 items-center">
        <select name="date" class="form-select">
          <option value="">All Days</option>
          {% for date in dates %}
            <option value="{{ date|date:'Y-m-d' }}"
                    {% if date|date:'Y-m-d' == selected_date %}selected{% endif %}>
              {% if has_multiple_years %}
                {{ date|date:"l, F j, Y" }}
              {% else %}
                {{ date|date:"l, F j" }}
              {% endif %}
            </option>
          {% endfor %}
        </select>
        <select name="room" class="form-select">
          <option value="">All Rooms</option>
          {% for room in rooms %}
            <option value="{{ room.id }}"
                    {% if room.id|stringformat:"s" == selected_room %}selected{% endif %}>{{ room.name }}</option>
          {% endfor %}
        </select>
        <select name="presentation_type" class="form-select">
          <option value="">All Types</option>
          {% for type_value, type_label in presentation_types %}
            <option value="{{ type_value }}"
                    {% if type_value == selected_type %}selected{% endif %}>{{ type_label }}</option>
          {% endfor %}
        </select>
        <select name="track" class="form-select truncate w-60">
          <option value="">All Tracks</option>
          {% for track in tracks %}
            <option value="{{ track }}"
                    {% if track == selected_track %}selected{% endif %}>{{ track }}</option>
          {% endfor %}
        </select>
      </form>
    </div>
    <!-- Define the talks partial -->
    {% startpartial talk-list %}
    <div class="space-y-4">
      {% for talk in talks %}
        <div class="relative rounded shadow overflow-hidden {% if talk.is_current %} ring-current {% elif talk.is_upcoming %} ring-upcoming {% endif %}">
          <!-- Status indicator bar -->
          <div class="absolute left-0 top-0 bottom-0 w-1.5 {% if talk.is_current %} status-bar-current {% elif talk.is_upcoming %} status-bar-upcoming {% else %} status-bar-default {% endif %}">
          </div>
          <div class="p-4 {% if talk.is_current %} card-bg-current {% elif talk.is_upcoming %} card-bg-upcoming {% else %} card-bg-default {% endif %}">
            <!-- Title and status badge -->
            <div class="flex justify-between items-start">
              <a href="{% url 'talk_detail' talk.pk %}" class="link-title pl-2">{{ talk.title|highlight:search_query }}</a>
              {% if talk.is_current %}
                <span class="badge badge-orange px-2 py-0.5 text-xs font-medium flex items-center flex-shrink-0 whitespace-nowrap">
                  {% svg 'clock' "h-3 w-3 mr-1" %}
                  HAPPENING NOW
                </span>
              {% elif talk.is_upcoming %}
                <span class="badge badge-blue text-xs font-medium flex items-center flex-shrink-0 whitespace-nowrap">
                  {% svg 'calendar' "h-3 w-3 mr-1" %}
                  UPCOMING
                </span>
              {% else %}
                <span class="badge badge-gray text-xs font-medium flex items-center flex-shrink-0 whitespace-nowrap">
                  {% svg 'check-circle' "h-3 w-3 mr-1" %}
                  COMPLETED
                </span>
              {% endif %}
            </div>
            <p class="text-muted pl-2">{{ talk.speaker_names|highlight:search_query }}</p>
            <!-- Rating -->
            <div class="mt-1 pl-2">{% star_rating talk.average_rating talk.rating_count %}</div>
            <!-- Date and Room info -->
            <div class="text-sm mt-2 pl-2">
              <span class="{% if talk.is_current %} badge badge-orange {% elif talk.is_upcoming %} badge badge-purple {% else %} badge badge-gray {% endif %}">{{ talk.start_time|date:"D, g:i A" }}</span>
              <span class="ml-2 badge badge-gray">{{ talk.room }}</span>
            </div>
            <!-- Presentation Type and Track info -->
            <div class="text-sm mt-1 pl-2">
              <span class="badge badge-green">{{ talk.get_presentation_type_display }}</span>
              <span class="ml-2 badge badge-blue">{{ talk.track }}</span>
            </div>
            <!-- Links -->
            <div class="mt-3 flex flex-wrap gap-2 pl-2">
              <a href="{{ talk.pretalx_link }}"
                 target="_blank"
                 rel="noopener noreferrer"
                 class="btn-outline-primary inline-flex items-center px-3 py-1 rounded">
                {% svg 'information-circle' "h-4 w-4 mr-1" %}
                Details
              </a>
              {% if talk.get_video_link %}
                <a href="{% url 'talk_detail' talk.pk %}"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="btn-danger inline-flex items-center px-3 py-1 rounded">
                  {% svg 'play-circle' "h-4 w-4 mr-1" %}
                  Video
                </a>
              {% endif %}
              <a href="{% url 'talk_questions' talk.pk %}"
                 class="btn-secondary inline-flex items-center px-3 py-1 rounded">
                {% svg 'chat-bubble-left-ellipsis' "h-4 w-4 mr-1" %}
                Q&amp;A
              </a>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="bg-surface p-4 rounded text-center text-subtle">No talks found</div>
      {% endfor %}
    </div>
  {% endpartial %}
  <!-- Talks container that references the partial -->
  <div id="talks-container"
       class="space-y-4"
       hx-get="{% url 'talk_list' %}"
       hx-include="#filters-form, #search-form"
       hx-trigger="every 300s">{% partial talk-list %}</div>
</div>
{% endblock content %}
